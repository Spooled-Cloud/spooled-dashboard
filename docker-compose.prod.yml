# ===========================================
# SPOOLED DASHBOARD - PRODUCTION DEPLOYMENT
# ===========================================
#
# Deploy via Portainer, Docker Compose, or any container orchestrator.
# Images are automatically built by GitHub Actions for amd64 and arm64.
#
# Quick start:
#   1. Copy .env.example to .env and configure
#   2. docker compose -f docker-compose.prod.yml up -d
#
# For Portainer:
#   1. Create a new Stack
#   2. Upload this file or paste contents
#   3. Add environment variables in the Portainer UI
#
# Required Environment Variables:
#   CLOUDFLARE_TUNNEL_TOKEN - Cloudflare tunnel token
#
# Optional Environment Variables:
#   DASHBOARD_IMAGE         - Docker image (default: ghcr.io/spooled-cloud/spooled-dashboard:latest)
#   PUBLIC_API_URL          - Backend API URL
#   PUBLIC_WS_URL           - WebSocket URL
#   PUBLIC_SENTRY_DSN       - Sentry DSN for error tracking
#
# Cloudflare Tunnel Routes (configure in Zero Trust dashboard):
#   - dashboard.spooled.cloud -> http://dashboard:4321

services:
  # ===========================================
  # Spooled Dashboard
  # ===========================================
  dashboard:
    image: ${DASHBOARD_IMAGE:-ghcr.io/spooled-cloud/spooled-dashboard:latest}
    container_name: spooled_dashboard
    restart: unless-stopped
    environment:
      # Server
      HOST: 0.0.0.0
      PORT: 4321
      NODE_ENV: production

      # API Configuration
      PUBLIC_API_URL: ${PUBLIC_API_URL:-https://api.spooled.cloud}
      PUBLIC_WS_URL: ${PUBLIC_WS_URL:-wss://api.spooled.cloud}

      # Feature Flags
      PUBLIC_ENABLE_WORKFLOWS: ${PUBLIC_ENABLE_WORKFLOWS:-true}
      PUBLIC_ENABLE_SCHEDULES: ${PUBLIC_ENABLE_SCHEDULES:-true}

      # Error Tracking (optional)
      PUBLIC_SENTRY_DSN: ${PUBLIC_SENTRY_DSN:-}
      PUBLIC_SENTRY_ENVIRONMENT: ${PUBLIC_SENTRY_ENVIRONMENT:-production}

      # Analytics (optional)
      PUBLIC_ENABLE_ANALYTICS: ${PUBLIC_ENABLE_ANALYTICS:-false}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:4321/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - spooled-network

  # ===========================================
  # Cloudflare Tunnel (Zero Trust Access)
  # ===========================================
  # Routes traffic to dashboard without exposing ports
  # Configure routes in Cloudflare Zero Trust dashboard:
  #   - dashboard.yourdomain.com -> http://dashboard:4321
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: spooled_dashboard_cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - dashboard
    networks:
      - spooled-network

networks:
  spooled-network:
    driver: bridge
